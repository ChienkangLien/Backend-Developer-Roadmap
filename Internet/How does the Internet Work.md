# How does the Internet Work?
## 基本概念和術語

* 資料封包Packet：透過網路傳輸的小資料單位。
* 路由器Router：在不同網路之間引導資料包的設備。
* IP 位址：分配給網路上每個裝置的唯一標識符，用於將資料路由到正確的目的地。
* 網域Domain Name：用於識別網站的人類可讀名稱，例如 google.com。
* DNS：Domain Name System負責將網域名稱轉換為IP位址。
* HTTP：超文本傳輸協定Hypertext Transfer Protocol用於在客戶端（例如網頁瀏覽器）和伺服器（例如網站）之間傳輸資料。
* HTTPS： HTTP 的加密版本，用於在客戶端和伺服器之間提供安全通訊。
* SSL/TLS：安全通訊端層Secure Sockets Layer和傳輸層安全協定Transport Layer Security用於透過網際網路提供安全通訊。
## 了解 IP 位址和域名
IP 位址是分配給網路上每個裝置的唯一識別碼。它用於將資料路由到正確的目的地，確保訊息傳送到預期的收件者。IP 位址通常表示為由句點分隔的一系列四個數字 ，nnn.nnn.nnn.nnn，其中 nnn 必須是 0 - 255 之間的數字，例如「192.168.1.1」。

另一方面，網域名稱是人類可讀的名稱，用於識別網站和其他網路資源。它們通常由兩個或多個部分組成，並以句點分隔。例如，「google.com」就是一個網域。使用Domain Name System (DNS，DNS 是一個分散式資料庫) 將網域轉換為 IP 位址。

當您在 Web 瀏覽器中輸入網域名稱時，您的電腦會向 DNS 伺服器發送 DNS 查詢，該伺服器會傳回對應的 IP 位址並連接到您要求的網站或其他資源。


---

許多連接到互聯網的電腦都託管著部分 DNS 資料庫以及允許其他人存取該資料庫的軟體。這些電腦稱為 DNS 伺服器。沒有 DNS server包含整個資料庫；它們只包含它的一個子集。如果 DNS 伺服器不包含另一台電腦請求的域名，則 DNS 伺服器會將請求電腦重新導向至另一台 DNS 伺服器。

![image](images/dns.png)

DNS的結構類似 IP 路由層次結構。請求名稱解析的電腦將被重定向到層次結構“向上”，直到找到可以解析請求中的網域的 DNS 伺服器。樹的頂部是域根。一些較舊的、更常見的網域位於頂部附近。沒有顯示的是世界各地的眾多 DNS 伺服器，它們構成了層次結構的其餘部分。
設定 Internet 連線時（例如，適用於 Windows 中的 LAN 或撥接網路），通常會在安裝過程中指定一台主 DNS 伺服器和一台或多台輔助 DNS 伺服器。這樣，任何需要網域解析的網路應用程式都能夠正常運作。
## HTTP 與 HTTPS 簡介
HTTP（Hypertext Transfer Protocol）和 HTTPS（HTTP Secure）是基於網際網路的應用程式和服務中最常用的兩種協定。

HTTP 是用於在用戶端（例如網頁瀏覽器）和伺服器（例如網站）之間傳輸資料的協定。當您造訪網站時，您的 Web 瀏覽器會向伺服器發送 HTTP 請求，請求提供您要求的網頁或其他資源。然後，伺服器將包含請求資料的 HTTP 回應傳送回客戶端。

伺服器處理請求後，客戶端和伺服器之間透過 Internet 的連線將會中斷。大多數協定都是面向連線的。這意味著相互通訊的兩台電腦透過 Internet 保持連線開啟。然而 HTTP 卻沒有。在客戶端發出 HTTP 請求之前，必須與伺服器建立新連線。

HTTPS 是 HTTP 的更安全版本，它使用 SSL/TLS（Secure Sockets Layer/Transport Layer Security）加密技術對客戶端和伺服器之間傳輸的資料進行加密。這提供了額外的安全層，有助於保護敏感資訊，例如登入憑證、付款資訊和其他個人資料。

當您造訪使用 HTTPS 的網站時，您的網頁瀏覽器會在網址列中顯示掛鎖圖標，表明連線是安全的。也可能會在網站地址開頭看到字母“https”，而不是“http”。
## 使用 TCP/IP 建立應用程式
TCP/IP（Transmission Control Protocol/Internet Protocol）是大多數基於網際網路的應用程式和服務所使用的底層通訊協定。它在不同設備上運行的應用程式之間提供可靠、有序且經過錯誤檢查的資料傳輸。

使用 TCP/IP 建立應用程式時，需要理解幾個關鍵概念：
* Ports：用於識別設備上執行的應用程式或服務。每個應用程式或服務都分配有一個唯一的port 號，允許將資料傳送到正確的目的地。
* Sockets：是 IP 位址和port號的組合，代表通訊的特定端點。socket 用於在裝置之間建立連接並在應用程式之間傳輸資料。
* Connections：當兩個裝置想要相互通訊時，在兩個sockets 之間建立連線。在連線建立過程中，裝置會協商各種參數，例如最大段大小和視窗大小，這些參數決定如何透過連線傳輸資料。
* 資料傳輸Data transfer：一旦建立連接，就可以在每個裝置上執行的應用程式之間傳輸資料。資料通常分段傳輸，每個段包含序號和其他元資料以確保可靠傳輸。

TCP/IP stack如下所示：


| 協定層 | 說明 |
| -------- | -------- |
|應用協定層Application Protocols Layer | 特定於應用程式的協議，如 WWW、電子郵件、FTP 等。|
|傳輸控制協定層Transmission Control Protocol Layer | TCP使用連接埠號碼將封包定向到電腦上的特定應用程式。|
|網際網路協定層Internet Protocol Layer | IP 使用 IP 位址將資料包導向至特定電腦。|
|硬體層Hardware Layer | 將二進位資料包資料轉換為網路訊號並返回。（例如乙太網路卡、電話線數據機等）|

如果我們要遵循訊息「Hello computer 5.6.7.8!」的路徑 從我們的電腦到IP位址為5.6.7.8的電腦，會發生這樣的事情：

![image](images/flow.png)


1. 該訊息將從電腦上協定棧protocol stack的頂部開始，然後向下工作。
2. 如果要傳送的訊息很長，則訊息經過的每個棧層都可能將訊息分解為更小的封包packets。這是因為透過網路（和大多數電腦網路）發送的資料是以可管理的區塊的形式發送的。
3. packets將通過應用層並繼續到達 TCP 層。每個packet都分配有一個port號。我們需要知道目標電腦上的哪個程式需要接收訊息，因為它將偵聽特定port。
4. 經過 TCP 層後，packet進入 IP 層。這是每個封包接收其目標位址 5.6.7.8 的地方。
5. 現在我們的訊息封包有了port號和 IP 位址，它們就可以透過 Internet 發送了。硬體層負責將包含訊息字母文字的封包轉換為電子訊號，並透過電話線傳輸它們。
6. 在電話線的另一端，您的 ISP 可以直接連接到網路。ISP router檢查每個封包中的目標位址並確定將其發送到何處。通常，封包的下一站是另一個路由器。
7. 最終，封包到達計算機 5.6.7.8。在這裡，封包從目標電腦的 TCP/IP stack的底部開始並向上工作。
8. 當封包向上通過棧時，發送電腦的棧所添加的所有路由資料（例如 IP 位址和port號）將從封包中剝離。
9. 當資料到達堆疊頂部時，封包已重新組裝為其原始形式“Hello computer 5.6.7.8!”

TCP 的工作原理如下：

* 當TCP層從上方接收到應用層協定資料時，它將其分割成可管理的“區塊”，然後在每個“區塊”中加入具有特定TCP資訊的TCP標頭。TCP 標頭中包含的資訊包括資料需要傳送到的應用程式的port號。
* 當TCP 層從其下面的IP 層接收到封包時，TCP 層會從資料包中剝離TCP 標頭數據，必要時進行一些資料重建，然後使用從TCP 取得的port號將資料傳送到正確的應用程序標頭。
* 請注意，TCP 標頭中沒有 IP 位址的位置。這是因為 TCP 不知道任何有關 IP 位址的資訊。TCP 的工作是在應用程式之間可靠地獲取應用程式級資料。從一台電腦到另一台電腦取得資料的任務就是 IP 的工作。

與 TCP 不同，IP 是一種不可靠、無連線的協定：
* IP 並不關心資料包是否到達目的地。IP 也不知道連接和port號。
* IP 的工作也是傳送和路由封包給其他電腦。IP 封包是獨立的實體，可能無序到達或根本不到達。TCP 的工作是確保資料包到達並按正確的順序排列。
* IP 與 TCP 唯一的共同點是它接收資料並將其自己的 IP 標頭資訊新增至 TCP 資料的方式。

下面是封包經過應用層、TCP 層和 IP 層後的樣子。應用層資料在TCP層分段，加入TCP報頭，資料包繼續到IP層，加入IP報頭，然後資料包透過網路傳輸。
![image](images/packet.png)

## 使用 SSL/TLS 保護網路通信
使用 SSL/TLS 保護網路通訊時，需要了解一些關鍵概念：

* 憑證： SSL/TLS 憑證用於在用戶端和伺服器之間建立信任。它們包含有關伺服器身分的信息，並由受信任的第三方（憑證授權單位）簽署以驗證其真實性。
* 握手：在 SSL/TLS 握手過程中，客戶端和伺服器交換資訊以協商安全連線的加密演算法和其他參數。
* 加密：建立安全連線後，資料將使用約定的演算法進行加密，並且可以在客戶端和伺服器之間安全傳輸。

SSL（Secure Sockets Layer） 和 TLS（Transport Layer Security）是用於加密網路通信的協議。TLS 與 SSL 實質上是相同的協議家族，但存在幾個主要的區別：

版本
* SSL：SSL 是較早的協議，最初由 Netscape 開發。它的版本包括 SSL 1.0、SSL 2.0、SSL 3.0。
* TLS：TLS 是 SSL 的後續版本，它是在 SSL 3.0 的基礎上進行改進和擴展。TLS 1.0 是作為 SSL 3.0 的後續版本開始，並持續發展到了現在的 TLS 1.3。

安全性
* TLS：TLS 相對於 SSL 提供了更高的安全性，它修復了 SSL 中的一些安全漏洞，並引入了更強大的加密算法和協議，比如支援完整的前向安全性（Forward Secrecy）等功能。
* SSL：較早期版本的 SSL 存在一些安全漏洞，例如 SSL 3.0 中的 POODLE 攻擊漏洞，這些漏洞已經被後續的 TLS 版本修復了。

協議支援
* TLS：TLS 的新版本獲得了更廣泛的支援，大多數現代瀏覽器和伺服器都支援 TLS 1.2 和 TLS 1.3。
* SSL：由於安全性和效能方面的限制，許多服務器和瀏覽器已經停止支援較舊的 SSL 版本，並傾向於使用更現代的 TLS 版本。
## SMTP 和電子郵件
電子郵件使用稱為簡單郵件傳輸協定Simple Mail Transfer Protocol或 SMTP 的應用程式層級協定。SMTP 也是基於文字的協議，但與 HTTP 不同，SMTP 是面向連接的。SMTP 也比 HTTP 更複雜。SMTP 中的命令和注意事項比 HTTP 中多得多。
當您開啟郵件用戶端來閱讀電子郵件時，通常會發生以下情況：
1. 郵件用戶端（Netscape Mail、Lotus Notes、Microsoft Outlook 等）開啟與其預設郵件伺服器的連線。郵件伺服器的IP位址或網域名稱通常在安裝郵件用戶端時設定。
2. mail server將始終傳輸第一條訊息來標識自己。
3. 客戶端將發送 SMTP HELO 命令，伺服器將用 250 OK 訊息回應該命令。
4. 根據客戶端是否正在檢查郵件、發送郵件等，相應的 SMTP 命令將被傳送到伺服器，伺服器將做出相應的回應。
5. 此請求/回應事務將繼續，直到客戶端發送 SMTP QUIT 命令。然後伺服器將說再見並且連接將關閉。

